<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RutaFácil PWA</title>
    
    <!-- CONEXIÓN CON EL MANIFEST (Clave para instalar) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags PWA -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button { user-select: none; -webkit-user-select: none; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden">
    
    <div id="root"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- REGISTRO DEL SERVICE WORKER -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado:', reg.scope))
                    .catch(err => console.log('Error Service Worker:', err));
            });
        }
    </script>

    <!-- LÓGICA DE LA APP -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS INLINE ---
        const IconBase = ({ size = 24, color = "currentColor", className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></IconBase>;
        const Navigation = (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11" /></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><path d="m15 9-6 6" /><path d="m9 9 6 6" /></IconBase>;
        const Phone = (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" /></IconBase>;
        const List = (props) => <IconBase {...props}><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></IconBase>;
        const Package = (props) => <IconBase {...props}><path d="m16.5 9.4-9-5.19" /><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const LinkIcon = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6" /></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6" /></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></IconBase>;
        const Wifi = (props) => <IconBase {...props}><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconBase>;
        const WifiOff = (props) => <IconBase {...props}><line x1="1" y1="1" x2="23" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" y1="20" x2="12.01" y2="20" /></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Share = (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" /></IconBase>;

        // --- COMPONENTE TARJETA DRAGGABLE ---
        const DeliveryCard = ({ item, index, onNavigate, onStatusChange, onCall, onDelete, onDragStart, onDragEnter, onDragEnd }) => {
            const [isOpen, setIsOpen] = useState(false);
            const isPending = item.status === 'pending';

            return (
                <div 
                    className={`bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden transition-all group ${!isPending ? 'opacity-60 bg-slate-50' : ''}`}
                    draggable={isPending}
                    onDragStart={(e) => isPending && onDragStart(e, index)}
                    onDragEnter={(e) => isPending && onDragEnter(e, index)}
                    onDragEnd={onDragEnd}
                    onDragOver={(e) => e.preventDefault()}
                >
                    <div className="flex items-stretch">
                        {isPending && (
                            <div className="w-8 bg-slate-50 border-r border-slate-100 flex items-center justify-center cursor-grab active:cursor-grabbing touch-none text-slate-400 hover:text-blue-500 hover:bg-slate-100 transition-colors">
                                <GripVertical size={16} />
                            </div>
                        )}

                        <div 
                            className="flex-1 p-3 flex items-center justify-between cursor-pointer active:bg-slate-50 select-none"
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <div className="flex-1 min-w-0 pr-2">
                                <div className="flex items-center gap-2">
                                    <h3 className={`font-bold text-slate-800 text-sm truncate ${!isPending && 'line-through decoration-slate-400'}`}>
                                        {item.name}
                                    </h3>
                                    {!isPending && (
                                        item.status === 'delivered' 
                                        ? <CheckCircle size={16} className="text-green-600 flex-shrink-0" />
                                        : <XCircle size={16} className="text-red-600 flex-shrink-0" />
                                    )}
                                </div>
                                <div className="flex items-center text-slate-500 text-xs mt-1">
                                    {item.mapLink ? <LinkIcon size={12} className="mr-1 text-orange-500 flex-shrink-0"/> : <MapPin size={12} className="mr-1 text-blue-500 flex-shrink-0"/>}
                                    <span className="truncate">{item.address}</span>
                                </div>
                            </div>
                            
                            <button className="text-slate-400 p-1">
                                {isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                            </button>
                        </div>
                    </div>

                    {isOpen && (
                        <div className={`px-3 pb-3 pt-1 border-t border-slate-100 bg-white ${isPending ? 'ml-8' : ''}`}>
                            {item.notes && (
                                <div className="mt-2 text-xs p-2 bg-yellow-50 text-yellow-800 rounded border border-yellow-100 mb-3 leading-relaxed">
                                    <span className="font-bold">Nota:</span> {item.notes}
                                </div>
                            )}

                            <div className="flex items-center justify-between gap-2 mt-2">
                                {isPending ? (
                                    <>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onNavigate(item); }}
                                                className="bg-blue-600 text-white w-11 h-11 rounded-lg flex items-center justify-center shadow-md shadow-blue-200 active:scale-95 transition-transform"
                                                title={item.mapLink ? "Abrir Link" : "Navegar GPS"}
                                            >
                                                {item.mapLink ? <LinkIcon size={20} /> : <Navigation size={20} />}
                                            </button>

                                            {item.phone && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onCall(item.phone); }}
                                                    className="bg-slate-100 text-slate-600 border border-slate-200 w-11 h-11 rounded-lg flex items-center justify-center active:scale-95 transition-transform"
                                                >
                                                    <Phone size={20} />
                                                </button>
                                            )}
                                        </div>

                                        <div className="flex gap-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onStatusChange(item.id, 'failed'); }}
                                                className="bg-white text-red-500 w-11 h-11 rounded-lg flex items-center justify-center border border-red-200 hover:bg-red-50 active:scale-95 transition-transform"
                                            >
                                                <XCircle size={24} />
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onStatusChange(item.id, 'delivered'); }}
                                                className="bg-green-500 text-white w-11 h-11 rounded-lg flex items-center justify-center shadow-md shadow-green-200 active:scale-95 transition-transform"
                                            >
                                                <CheckCircle size={24} />
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex justify-between w-full items-center">
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onDelete(item.id); }}
                                            className="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50"
                                            title="Eliminar cliente"
                                        >
                                            <Trash2 size={18} />
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onStatusChange(item.id, 'pending'); }}
                                            className="text-slate-500 text-xs flex items-center gap-2 px-3 py-2 bg-slate-100 border border-slate-200 rounded-lg hover:bg-slate-200"
                                        >
                                            <RotateCcw size={14} /> Deshacer Estado
                                        </button>
                                    </div>
                                )}
                            </div>
                             {isPending && (
                                <div className="flex justify-end mt-2 pt-2 border-t border-slate-50">
                                     <button 
                                        onClick={(e) => { e.stopPropagation(); if(confirm('¿Borrar este cliente?')) onDelete(item.id); }}
                                        className="text-red-300 hover:text-red-500 text-xs flex items-center gap-1"
                                    >
                                        <Trash2 size={12} /> Eliminar
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENTE MAPA ---
        const SimpleMap = ({ deliveries, onSelect }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current) return;
                if (mapInstanceRef.current) return; 

                try {
                    const map = L.map(mapContainerRef.current).setView([-34.6037, -58.3816], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap'
                    }).addTo(map);
                    mapInstanceRef.current = map;
                    setTimeout(() => map.invalidateSize(), 200);
                } catch (error) {
                    console.error("Error mapa:", error);
                }
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                map.eachLayer((layer) => { if (layer instanceof L.Marker) map.removeLayer(layer); });
                const bounds = L.latLngBounds();
                let hasPoints = false;
                deliveries.forEach(delivery => {
                    if (delivery.status === 'pending' && delivery.lat && delivery.lng && delivery.lat !== 0) {
                        const marker = L.marker([delivery.lat, delivery.lng])
                        .addTo(map)
                        .bindPopup(`<b>${delivery.name}</b><br>${delivery.address}`);
                        marker.on('click', () => { if (onSelect) onSelect(delivery); });
                        bounds.extend([delivery.lat, delivery.lng]);
                        hasPoints = true;
                    }
                });
                if (hasPoints) map.fitBounds(bounds, { padding: [50, 50] });
            }, [deliveries]);

            return <div ref={mapContainerRef} className="h-full w-full rounded-lg shadow-inner bg-slate-200 z-0"></div>;
        };

        // --- COMPONENTE GESTIÓN DE DATOS ---
        const DataManager = ({ isOpen, onClose, onImport, onAdd, onClear, data }) => {
            const [activeTab, setActiveTab] = useState('add'); 
            const [csvText, setCsvText] = useState('');
            const [entryMode, setEntryMode] = useState('link');
            const [newName, setNewName] = useState('');
            const [newAddress, setNewAddress] = useState('');
            const [newPhone, setNewPhone] = useState('');
            const [newLat, setNewLat] = useState('');
            const [newLng, setNewLng] = useState('');
            const [newMapLink, setNewMapLink] = useState('');
            const [newNotes, setNewNotes] = useState('');
            const fileInputRef = useRef(null);

            if (!isOpen) return null;

            const handleImport = () => {
                const lines = csvText.split('\n');
                const newItems = [];
                lines.forEach((line, index) => {
                    if (!line.trim()) return;
                    let parts = line.includes('\t') ? line.split('\t') : line.includes(';') ? line.split(';') : line.split(',');
                    parts = parts.map(p => p ? p.trim().replace(/^"|"$/g, '') : '');
                    if (parts.length >= 3) {
                        const col3 = parts[2]; 
                        const isLink = col3.toLowerCase().startsWith('http');
                        const combinedCoordsMatch = col3.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
                        let item = { id: Date.now() + index + Math.random(), name: parts[0], address: parts[1], status: 'pending', notes: '', phone: '' };
                        if (isLink) { item.mapLink = col3; item.lat = 0; item.lng = 0; item.phone = parts[3]; item.notes = parts[4]; } 
                        else if (combinedCoordsMatch) { item.lat = parseFloat(combinedCoordsMatch[1]); item.lng = parseFloat(combinedCoordsMatch[2]); item.phone = parts[3]; item.notes = parts[4]; } 
                        else { item.lat = parseFloat(col3); item.lng = parseFloat(parts[3]); item.phone = parts[4]; item.notes = parts[5]; }
                        if(!isNaN(item.lat) || isLink) newItems.push(item);
                    }
                });
                if (newItems.length > 0) { onImport(newItems); setCsvText(''); onClose(); alert(`Importados ${newItems.length} clientes.`); } 
                else { alert("Error en formato."); }
            };

            const handleAddSingle = (e) => {
                e.preventDefault();
                const item = { id: Date.now(), name: newName, address: newAddress, phone: newPhone, notes: newNotes, status: 'pending' };
                if (entryMode === 'link') { if (!newMapLink) return alert("Falta Link"); item.mapLink = newMapLink; item.lat = 0; item.lng = 0; } 
                else { if (!newLat || !newLng) return alert("Faltan Coordenadas"); item.lat = parseFloat(newLat); item.lng = parseFloat(newLng); }
                onAdd(item);
                setNewName(''); setNewAddress(''); setNewPhone(''); setNewNotes(''); setNewMapLink(''); setNewLat(''); setNewLng('');
                alert("Cliente agregado.");
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "rutafacil_backup_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            // NUEVA FUNCIÓN: Compartir vía WhatsApp
            const handleWhatsAppShare = async () => {
                const fileName = "backup_rutafacil.json";
                const jsonString = JSON.stringify(data, null, 2);
                
                if (navigator.share) {
                    try {
                        const file = new File([jsonString], fileName, { type: 'application/json' });
                        // Algunos navegadores no permiten compartir archivos directamente, probamos canShare
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: 'Copia de Seguridad RutaFácil',
                                text: 'Envío mi copia de seguridad de la ruta.'
                            });
                        } else {
                            // Fallback: Compartir como texto
                            await navigator.share({
                                title: 'Backup RutaFácil',
                                text: `MI RUTA ACTUAL (${data.length} clientes):\n\n${jsonString}`
                            });
                        }
                    } catch (error) {
                        console.log("Compartir cancelado o no soportado:", error);
                    }
                } else {
                    // Fallback para navegadores antiguos: Abrir WhatsApp Web con el texto (limitado por longitud)
                    alert("Tu navegador no soporta compartir archivos. Usa 'Descargar Copia' y envíala manualmente.");
                }
            };

            const handleRestore = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if(Array.isArray(restoredData)){
                            if(confirm(`Se encontraron ${restoredData.length} clientes. ¿Reemplazar lista actual?`)){
                                onClear(); onImport(restoredData); onClose(); alert("Restauración completada.");
                            }
                        }
                    } catch (error) { alert("Error al leer archivo."); }
                };
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-lg font-bold flex items-center gap-2"><Settings size={20} /> Gestión</h2>
                            <button onClick={onClose} className="p-1 hover:bg-slate-100 rounded-full"><X size={20} /></button>
                        </div>
                        <div className="p-4">
                            <div className="flex gap-2 mb-4">
                                <button onClick={() => setActiveTab('add')} className={`flex-1 py-2 text-sm font-bold rounded-lg border ${activeTab === 'add' ? 'bg-blue-50 text-blue-700' : 'text-slate-500'}`}>Manual</button>
                                <button onClick={() => setActiveTab('import')} className={`flex-1 py-2 text-sm font-bold rounded-lg border ${activeTab === 'import' ? 'bg-blue-50 text-blue-700' : 'text-slate-500'}`}>Excel</button>
                                <button onClick={() => setActiveTab('backup')} className={`flex-1 py-2 text-sm font-bold rounded-lg border ${activeTab === 'backup' ? 'bg-blue-50 text-blue-700' : 'text-slate-500'}`}>Backup</button>
                            </div>

                            {activeTab === 'add' && (
                                <form onSubmit={handleAddSingle} className="space-y-3">
                                    <input required value={newName} onChange={e => setNewName(e.target.value)} className="w-full p-2 border rounded" placeholder="Nombre" />
                                    <input value={newAddress} onChange={e => setNewAddress(e.target.value)} className="w-full p-2 border rounded" placeholder="Dirección" />
                                    <div className="flex gap-2 bg-slate-100 p-1 rounded mb-2">
                                        <button type="button" onClick={() => setEntryMode('link')} className={`flex-1 py-1 text-xs font-bold rounded ${entryMode === 'link' ? 'bg-white shadow' : 'text-slate-500'}`}>Link</button>
                                        <button type="button" onClick={() => setEntryMode('coords')} className={`flex-1 py-1 text-xs font-bold rounded ${entryMode === 'coords' ? 'bg-white shadow' : 'text-slate-500'}`}>Coord</button>
                                    </div>
                                    {entryMode === 'link' ? <input value={newMapLink} onChange={e => setNewMapLink(e.target.value)} className="w-full p-2 border rounded" placeholder="Link de Maps" /> : <div className="flex gap-2"><input type="number" step="any" value={newLat} onChange={e => setNewLat(e.target.value)} className="w-full p-2 border rounded" placeholder="Lat" /><input type="number" step="any" value={newLng} onChange={e => setNewLng(e.target.value)} className="w-full p-2 border rounded" placeholder="Lng" /></div>}
                                    <input value={newPhone} onChange={e => setNewPhone(e.target.value)} className="w-full p-2 border rounded" placeholder="Teléfono" />
                                    <input value={newNotes} onChange={e => setNewNotes(e.target.value)} className="w-full p-2 border rounded" placeholder="Notas" />
                                    <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-2">Guardar</button>
                                </form>
                            )}
                            
                            {activeTab === 'import' && (
                                <div className="space-y-2">
                                    <textarea value={csvText} onChange={e => setCsvText(e.target.value)} className="w-full h-32 p-2 border rounded text-xs font-mono" placeholder="Pegar datos aquí..." />
                                    <button onClick={handleImport} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><Upload size={18} /> Importar</button>
                                </div>
                            )}

                            {activeTab === 'backup' && (
                                <div className="space-y-4">
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 text-center">
                                        <h3 className="font-bold text-slate-700 mb-2 text-sm">Copia de Seguridad</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={handleExport} className="bg-blue-600 text-white py-3 rounded-lg font-bold flex flex-col items-center justify-center gap-1 text-xs">
                                                <Download size={20} /> Descargar
                                            </button>
                                            <button onClick={handleWhatsAppShare} className="bg-green-600 text-white py-3 rounded-lg font-bold flex flex-col items-center justify-center gap-1 text-xs">
                                                <Share size={20} /> WhatsApp
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 text-center">
                                        <h3 className="font-bold text-slate-700 mb-2 text-sm">Restaurar Copia</h3>
                                        <input type="file" ref={fileInputRef} onChange={handleRestore} accept=".json" className="hidden" />
                                        <button onClick={() => fileInputRef.current.click()} className="w-full bg-orange-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 text-xs">
                                            <Upload size={18} /> Subir archivo .json
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="border-t mt-4 pt-4">
                                <button onClick={() => { if(confirm("¿Borrar todo?")) { onClear(); onClose(); } }} className="w-full py-2 text-red-600 border border-red-200 rounded text-sm">Borrar Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [deliveries, setDeliveries] = useState(() => {
                const saved = localStorage.getItem('rutafacil_data');
                return saved ? JSON.parse(saved) : [{ id: 1, name: 'Ejemplo Demo', address: 'Buenos Aires', lat: -34.6037, lng: -58.3816, phone: '', status: 'pending', notes: 'Prueba' }];
            });
            const [view, setView] = useState('list'); 
            const [filter, setFilter] = useState('all'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [isManagerOpen, setIsManagerOpen] = useState(false);
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            useEffect(() => {
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); });
            }, []);

            useEffect(() => localStorage.setItem('rutafacil_data', JSON.stringify(deliveries)), [deliveries]);

            const handleInstall = async () => {
                if (!installPrompt) return;
                installPrompt.prompt();
                const { outcome } = await installPrompt.userChoice;
                if (outcome === 'accepted') setInstallPrompt(null);
            };

            const filteredDeliveries = deliveries.filter(d => {
                const term = searchTerm.toLowerCase();
                const matchSearch = (d.name || '').toLowerCase().includes(term) || (d.address || '').toLowerCase().includes(term);
                const matchFilter = filter === 'all' ? true : filter === 'pending' ? d.status === 'pending' : d.status !== 'pending';
                return matchSearch && matchFilter;
            });

            const handleDragEnd = () => {
                if (searchTerm !== '') return; 
                const newDeliveries = [...deliveries];
                const visibleItems = filteredDeliveries;
                const movedItem = visibleItems[dragItem.current];
                const targetItem = visibleItems[dragOverItem.current];
                if (!movedItem || !targetItem || movedItem === targetItem) return;
                const realSource = newDeliveries.findIndex(d => d.id === movedItem.id);
                const realTarget = newDeliveries.findIndex(d => d.id === targetItem.id);
                const itemContent = newDeliveries[realSource];
                newDeliveries.splice(realSource, 1);
                newDeliveries.splice(realTarget, 0, itemContent);
                setDeliveries(newDeliveries);
            };

            const pendingCount = deliveries.filter(d => d.status === 'pending').length;
            const progress = deliveries.length === 0 ? 0 : Math.round((deliveries.filter(d => d.status === 'delivered').length / deliveries.length) * 100);

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-800">
                    <header className={`${isOnline ? 'bg-blue-600' : 'bg-slate-700'} text-white p-3 shadow-md transition-colors z-10`}>
                        <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2">
                                <div className="bg-white/20 p-2 rounded-lg"><Package size={20} /></div>
                                <div><h1 className="text-lg font-bold leading-tight">RutaFácil</h1><p className="text-[10px] opacity-90">{isOnline ? 'Online' : 'Offline'} • {pendingCount} pendientes</p></div>
                            </div>
                            <div className="flex gap-2">
                                {installPrompt && <button onClick={handleInstall} className="bg-white text-blue-600 p-2 rounded-full"><Download size={18} /></button>}
                                <button onClick={() => setIsManagerOpen(true)} className="p-2 bg-white/20 rounded-full"><Settings size={18} /></button>
                                <button onClick={() => {if(confirm("¿Reiniciar día?")) setDeliveries(p=>p.map(d=>({...d, status:'pending'})))}} className="p-2 bg-white/20 rounded-full"><RotateCcw size={18} /></button>
                            </div>
                        </div>
                    </header>
                    <div className="bg-white p-3 shadow-sm border-b border-slate-200">
                        <div className="w-full bg-slate-200 h-1.5 rounded-full mb-3 overflow-hidden"><div className="bg-green-500 h-full transition-all" style={{ width: `${progress}%` }}></div></div>
                        <div className="flex justify-between items-center gap-2">
                            <div className="flex bg-slate-100 rounded-lg p-1">
                                <button onClick={() => setView('list')} className={`p-2 rounded-md ${view === 'list' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}><List size={18} /></button>
                                <button onClick={() => setView('map')} className={`p-2 rounded-md ${view === 'map' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}><MapIcon size={18} /></button>
                            </div>
                            <div className="relative flex-1">
                                <input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-8 pr-2 py-2 bg-slate-100 border-none rounded-lg text-sm outline-none" />
                                <Search className="absolute left-2 top-2.5 text-slate-400" size={16} />
                            </div>
                        </div>
                    </div>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'map' ? <SimpleMap deliveries={deliveries} onSelect={(d) => { setSearchTerm(d.name); setView('list'); }} /> : (
                            <div className="h-full overflow-y-auto p-4 space-y-3 pb-20">
                                <div className="flex gap-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                                    <button onClick={() => setFilter('all')} className={`px-4 py-1.5 rounded-full text-[10px] font-bold border ${filter === 'all' ? 'bg-blue-600 text-white' : 'bg-white'}`}>Todos</button>
                                    <button onClick={() => setFilter('pending')} className={`px-4 py-1.5 rounded-full text-[10px] font-bold border ${filter === 'pending' ? 'bg-orange-500 text-white' : 'bg-white'}`}>Pendientes</button>
                                    <button onClick={() => setFilter('completed')} className={`px-4 py-1.5 rounded-full text-[10px] font-bold border ${filter === 'completed' ? 'bg-green-600 text-white' : 'bg-white'}`}>Listos</button>
                                </div>
                                {filteredDeliveries.map((item, index) => (
                                    <DeliveryCard key={item.id} index={index} item={item} onNavigate={(i) => { if(i.mapLink) window.open(i.mapLink, '_blank'); else window.open(`https://www.google.com/maps/dir/?api=1&destination=${i.lat},${i.lng}`, '_blank'); }} onStatusChange={(id, s) => setDeliveries(p => p.map(d => d.id === id ? { ...d, status: s } : d))} onDelete={(id) => setDeliveries(p => p.filter(d => d.id !== id))} onCall={(ph) => window.open(`tel:${ph}`, '_self')} onDragStart={(e, pos) => {dragItem.current=pos}} onDragEnter={(e, pos) => {dragOverItem.current=pos}} onDragEnd={handleDragEnd} />
                                ))}
                            </div>
                        )}
                    </main>
                    <DataManager isOpen={isManagerOpen} onClose={() => setIsManagerOpen(false)} onImport={(d) => setDeliveries(prev => [...prev, ...d])} onAdd={(d) => setDeliveries(prev => [...prev, d])} onClear={() => setDeliveries([])} data={deliveries} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
